<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WebContainer Localhost Host</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
  input, button { padding: 10px; font-size: 16px; width: 100%; max-width: 500px; margin: 5px 0; }
  iframe { width: 100%; height: 500px; border: 1px solid #ccc; margin-top: 20px; }
  #status { margin-top: 10px; font-weight: bold; }
</style>
</head>
<body>
<h1>WebContainer Localhost Simulator</h1>

<input type="text" id="repoUrl" placeholder="Enter public GitHub repo URL">
<button id="startBtn">Start Server</button>

<div id="status"></div>
<iframe id="preview"></iframe>

<script type="module">
import { WebContainer } from 'https://cdn.jsdelivr.net/npm/@webcontainer/api@1.0.0/dist/webcontainer.js';

const statusEl = document.getElementById('status');
const preview = document.getElementById('preview');
const startBtn = document.getElementById('startBtn');

let webcontainerInstance;

startBtn.onclick = async () => {
  const repoUrl = document.getElementById('repoUrl').value.trim();
  if (!repoUrl) {
    statusEl.textContent = 'Enter a GitHub repo URL';
    return;
  }

  statusEl.textContent = 'Booting WebContainer...';

  // Start WebContainer
  webcontainerInstance = await WebContainer.boot();

  // Minimal package.json for Node.js server
  await webcontainerInstance.fs.writeFile('/package.json', JSON.stringify({
    name: 'webcontainer-localhost',
    type: 'module',
    scripts: { start: 'node index.js' },
    dependencies: { express: '^4.18.2', 'node-fetch': '^3.3.2' }
  }));

  // index.js server code inside the WebContainer
  const serverCode = `
import express from "express";
import fetch from "node-fetch";
import fs from "fs";
import path from "path";

const app = express();
const PORT = 3000;
app.use(express.static('./'));

// Endpoint to clone repo
app.get("/clone", async (req, res) => {
  const repoUrl = req.query.repo;
  if (!repoUrl) return res.status(400).send("No repo provided");

  try {
    const match = repoUrl.match(/github\\.com\\/([^\\/]+)\\/([^\\/]+)/);
    if (!match) throw new Error("Invalid GitHub repo URL");
    const user = match[1], repo = match[2];
    const apiUrl = \`https://api.github.com/repos/\${user}/\${repo}/contents/\`;
    const response = await fetch(apiUrl);
    if (!response.ok) throw new Error("Failed to fetch repo");
    const files = await response.json();

    for (const file of files) {
      if(file.type==="file") {
        const contentResp = await fetch(file.download_url);
        const content = await contentResp.text();
        fs.writeFileSync(path.join('./', file.name), content);
      }
    }
    res.send(\`Repo \${repo} cloned. Visit /index.html\`);
  } catch(e){ res.status(500).send(e.message) }
});

app.listen(PORT, ()=> console.log("Server running on port", PORT));
`;

  await webcontainerInstance.fs.writeFile('/index.js', serverCode);

  statusEl.textContent = 'Installing dependencies...';
  await webcontainerInstance.spawn('npm', ['install']);

  statusEl.textContent = 'Starting server...';
  const serverProcess = await webcontainerInstance.spawn('npm', ['start'], { stdout: true, stderr: true });

  serverProcess.output.pipeTo(new WritableStream({
    write(data) { console.log(data); }
  }));

  // Get the server URL in WebContainer
  const serverUrl = await webcontainerInstance.url(3000);
  statusEl.textContent = `Server running at: ${serverUrl}`;

  // Optionally auto-clone the repo
  await fetch(`${serverUrl}/clone?repo=${encodeURIComponent(repoUrl)}`);

  // Preview index.html from the repo
  preview.src = `${serverUrl}/index.html`;
};
</script>
</body>
</html>
