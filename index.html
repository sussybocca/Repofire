<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GitHub → Netlify Deploy</title>
<style>
body { font-family: Arial; padding: 20px; background: #f0f0f0; }
input, button { width: 100%; max-width: 400px; padding: 10px; margin: 5px 0; }
iframe { width: 100%; height: 400px; border: 1px solid #ccc; margin-top: 20px; }
#status { margin-top: 10px; font-weight: bold; color: green; }
#error { margin-top: 10px; font-weight: bold; color: red; }
#hiddenGitHub { position: fixed; bottom: 10px; left: 10px; font-size: 12px; }
#hiddenGitHub input { width: 200px; }
</style>
</head>
<body>

<h1>GitHub → Netlify One-Click Deploy</h1>

<p>Step 1: Enter Netlify Access Token</p>
<input type="text" id="netlifyToken" placeholder="Enter Netlify Personal Access Token">
<button onclick="deploySite()">Run & Deploy</button>

<div id="status"></div>
<div id="error"></div>
<iframe id="preview"></iframe>

<!-- Hidden corner for GitHub repo input -->
<div id="hiddenGitHub">
  <label>Paste GitHub URL: </label>
  <input type="text" id="githubUrl" placeholder="https://github.com/user/repo">
  <button onclick="fetchRepo()">Initialize Repo</button>
</div>

<script>
let siteFiles = {};

async function fetchRepo() {
  const url = document.getElementById('githubUrl').value.trim();
  const status = document.getElementById('status');
  const error = document.getElementById('error');
  status.textContent = '';
  error.textContent = '';

  if (!url) return alert('Enter a GitHub URL');

  try {
    status.textContent = 'Fetching repo files...';
    const res = await fetch('http://localhost:3000/fetch-repo', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ repoUrl: url })
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error);

    siteFiles = data;
    status.textContent = `Repo initialized with ${Object.keys(siteFiles).length} files. Ready to deploy.`;
    if (siteFiles['index.html']) {
      document.getElementById('preview').srcdoc = siteFiles['index.html'];
    }

  } catch (e) {
    error.textContent = e.message;
  }
}

async function deploySite() {
  const token = document.getElementById('netlifyToken').value.trim();
  const status = document.getElementById('status');
  const error = document.getElementById('error');
  const preview = document.getElementById('preview');
  status.textContent = '';
  error.textContent = '';

  if (!token) return alert('Enter Netlify token');
  if (!siteFiles || !siteFiles['index.html']) return alert('No site files found. Initialize GitHub repo first.');

  try {
    status.textContent = 'Deploying to Netlify...';
    const res = await fetch('http://localhost:3000/deploy', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ netlifyToken: token, siteFiles })
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error);

    status.textContent = `Site deployed: ${data.url}`;
    preview.src = data.url;

  } catch (e) {
    error.textContent = e.message;
  }
}
</script>

</body>
</html>
